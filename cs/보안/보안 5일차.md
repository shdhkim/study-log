# 세션 상태 정리  

작성 기준  
- Spring / Spring Security  
- HTTP / Cookie / Session / Authentication 관계 명확화  
- 실무에서 헷갈리는 “세션 상태 3종”을 구조적으로 구분

---

## 0. 핵심 요약 한 줄

```text
쿠키는 클라이언트 식별자
세션은 서버 저장 공간
인증은 세션 안의 사용자 정보
```

---

## 1. 쿠키 ❌ 세션 ❌ 상태 (완전 최초 상태)

### 1.1 상태 설명
```http
요청 헤더에 Cookie 없음
```

- 브라우저: JSESSIONID 없음
- 서버: 세션 없음
- 사용자: 완전 익명

---

### 1.2 서버 내부 상태
```text
HttpSession ❌
SecurityContext ❌
Authentication ❌
```

---

### 1.3 서버 판단
- 사용자를 전혀 구분하지 못함
- 모든 요청은 신규 사용자로 처리

---

### 1.4 언제 이런 상태가 되나?
- 브라우저 첫 접속
- 쿠키 삭제 후 재접속
- 시크릿 모드
- 로그아웃 + 쿠키 삭제

---

### 1.5 가능 / 불가능한 것

| 항목 | 가능 여부 |
|---|---|
| 로그인 페이지 접근 | 가능 |
| 로그인 요청 | 가능 |
| CSRF 토큰 발급 | ❌ (세션 필요) |
| 사용자 상태 저장 | ❌ |

---

## 2. 쿠키 ⭕ 세션 ⭕ 로그인 ❌ 상태 (익명 세션)

### 2.1 상태 설명
```http
Cookie: JSESSIONID=ABC123
```

- 브라우저: 세션 쿠키 보유
- 서버: 세션 존재
- 인증 정보 없음

---

### 2.2 서버 내부 상태
```text
HttpSession ⭕
 ├─ CSRF 토큰
 ├─ 임시 상태 값
 └─ 인증 정보 ❌

SPRING_SECURITY_CONTEXT ❌
```

---

### 2.3 서버 판단
```text
세션은 있음
하지만 누군지는 모름
```

Spring Security는 요청 처리 중 임시로:
```text
AnonymousAuthenticationToken
```
을 사용함 (세션 저장 ❌)

---

### 2.4 이 상태가 생기는 이유

#### ① CSRF 토큰 저장
```java
session.setAttribute("_csrf", token);
```

#### ② 로그인 실패 메시지
```java
session.setAttribute("error", "비밀번호 오류");
```

#### ③ 이전 페이지 기억
```java
session.setAttribute("redirect", "/admin");
```

---

### 2.5 가능 / 불가능한 것

| 항목 | 가능 여부 |
|---|---|
| 로그인 페이지 접근 | 가능 |
| 로그인 요청 | 가능 |
| POST 요청(CSRF 보호) | 가능 |
| 보호된 API 접근 | ❌ |

---

## 3. 쿠키 ⭕ 세션 ⭕ 로그인 ⭕ 상태 (인증 세션)

### 3.1 상태 설명
```http
Cookie: JSESSIONID=XYZ789
```

- 브라우저: 세션 쿠키 보유
- 서버: 세션 존재
- 인증 정보 존재

---

### 3.2 서버 내부 상태
```text
HttpSession ⭕
 └─ SPRING_SECURITY_CONTEXT
     └─ Authentication
         ├─ principal (UserDetails)
         ├─ authorities (ROLE_*)
         └─ authenticated = true
```

---

### 3.3 서버 판단
```text
이 사용자는 누구인지 확인됨
```

---

### 3.4 이 상태는 언제 생기나?

```text
로그인 성공 시
```

Spring Security 흐름:
1. ID / PW 검증
2. Authentication 생성
3. SecurityContext 생성
4. 세션에 저장
5. 세션 ID 변경 (보안)

---

### 3.5 가능 / 불가능한 것

| 항목 | 가능 여부 |
|---|---|
| 보호 API 접근 | 가능 |
| 권한 기반 접근 | 가능 |
| 사용자 식별 | 가능 |
| 세션 탈취 시 위험 | 매우 큼 |

---

## 4. 세션 생성과 인증의 관계 (오해 정리)

### ❌ 잘못된 생각
```text
세션이 생성되면 인증된 것이다
```

### ✅ 정확한 개념
```text
세션은 저장 공간
인증은 저장된 내용
```

- 세션은 비어 있을 수 있음
- 인증은 자동으로 생성되지 않음

---

## 5. 세 상태 비교 요약표

| 구분 | 쿠키 없음 | 익명 세션 | 로그인 세션 |
|---|---|---|---|
| JSESSIONID | ❌ | ⭕ | ⭕ |
| HttpSession | ❌ | ⭕ | ⭕ |
| 인증 정보 | ❌ | ❌ | ⭕ |
| 사용자 식별 | ❌ | ❌ | ⭕ |
| 보호 API 접근 | ❌ | ❌ | ⭕ |

---

## 6. 핵심 문장 정리

> 세션은 언제든 생성될 수 있다  
> 인증은 로그인 성공 시에만 생긴다  
> 쿠키는 세션을 가리키는 표식일 뿐이다  

---

## 7. 한 문장 최종 정리

> **쿠키 없음 → 서버가 모르는 사용자  
> 쿠키 있음 + 인증 없음 → 추적만 가능한 사용자  
> 쿠키 있음 + 인증 있음 → 식별된 사용자**
