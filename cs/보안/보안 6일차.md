# SSO 쿠키 기반 토큰 방식 상세 동작 정리

작성 기준  
- 사내 SSO / Spring Security / OAuth2 개념 공통 적용  
- 쿠키 기반이지만 **본질은 토큰 인증**이라는 관점에서 설명  
- Opaque Token / 서명 토큰(JWT) 모두 포함

---

## 1. SSO 쿠키 토큰 방식의 핵심 개념

### 한 줄 정의
> **SSO 쿠키 방식이란  
> 중앙 인증 서버(IdP)가 발급한 ‘인증 토큰’을  
> 브라우저 쿠키에 저장하고  
> 여러 서비스가 이를 신뢰하여 인증을 공유하는 구조이다.**

---

## 2. 구성 요소 역할 분리

| 구성 요소 | 역할 |
|---|---|
| 브라우저(Client) | 쿠키 자동 전송 |
| 인증 서버(IdP) | 로그인 수행, 토큰 발급 |
| 서비스 서버(SP) | 토큰 검증 후 사용자 인증 |
| 쿠키 | 토큰 전달 수단 |
| 토큰 | 인증의 본질 |

---

## 3. 쿠키에 들어가는 토큰의 정체

쿠키에는 **세션 ID가 아니라 인증 토큰**이 들어간다.

```http
Set-Cookie: SSO_TOKEN=T12345; Domain=.company.com; HttpOnly; Secure
```

### 토큰 종류
- **Opaque Token**: 의미 없는 랜덤 값
- **서명 토큰(JWT)**: 사용자 정보 + 서명 포함

---

## 4. 전체 동작 흐름 (로그인 전 → SSO 성립)

---

### 4.1 서비스 최초 접근 (비인증)

```http
GET https://serviceA.company.com
```

- SSO 쿠키 없음
- 서비스 A 판단: 인증 안 됨
- 중앙 인증 서버로 리다이렉트

```http
302 Location: https://auth.company.com/login
```

---

### 4.2 인증 서버에서 로그인

```http
POST https://auth.company.com/login
```

- ID / PW 검증
- 사용자 신원 확인

---

### 4.3 인증 서버가 SSO 토큰 발급

```text
SSO_TOKEN = T12345
```

```http
Set-Cookie: SSO_TOKEN=T12345; Domain=.company.com; HttpOnly; Secure
```

#### 쿠키 옵션 의미
- `Domain=.company.com` : 모든 하위 서비스 공유
- `HttpOnly` : JS 접근 차단
- `Secure` : HTTPS 전용
- `SameSite=None` : SSO 허용

---

### 4.4 다시 서비스로 복귀

```http
GET https://serviceA.company.com
Cookie: SSO_TOKEN=T12345
```

브라우저가 **자동으로 쿠키 전송**

---

## 5. 서비스 서버에서 인증 처리 (핵심)

서비스는 쿠키를 보고 **로그인 처리**를 수행한다.

---

## 6. 방식 1: Opaque Token 검증 (인증 서버 조회)

### 6.1 흐름

```text
Client → Service → Auth Server
```

```http
POST https://auth.company.com/introspect
Authorization: Bearer T12345
```

응답:
```json
{
  "userId": "kim",
  "roles": ["USER"]
}
```

---

### 6.2 특징

- 토큰 자체에 의미 없음
- 사용자 정보는 인증 서버가 관리
- 중앙 통제 가능

---

### 6.3 장단점

| 항목 | 설명 |
|---|---|
| 보안 | 매우 강함 |
| 즉시 로그아웃 | 가능 |
| 인증 서버 부하 | 높음 |
| 확장성 | 중간 |

---

## 7. 방식 2: 서명 토큰(JWT) 직접 검증

### 7.1 흐름

```text
Client → Service (검증 완료)
```

서비스 내부 처리:
1. 서명 검증 (공개키)
2. 만료(exp) 확인
3. 사용자 정보 파싱

---

### 7.2 특징

- 인증 서버 호출 없음
- 토큰 자체가 신원 증명서

---

### 7.3 장단점

| 항목 | 설명 |
|---|---|
| 성능 | 매우 좋음 |
| 확장성 | 매우 높음 |
| 즉시 로그아웃 | 어려움 |
| 키 관리 | 필요 |

---

## 8. 서비스 내부 세션과의 관계

### 중요한 사실
> **SSO 토큰 ≠ 서비스 세션**

서비스는 선택적으로:
- SSO 토큰만 사용하거나
- 내부 세션(JSESSIONID)을 따로 생성할 수 있다

```text
SSO 토큰: 전사 인증
서비스 세션: 서비스 내부 상태
```

---

## 9. 로그아웃 동작

### 9.1 Opaque Token 로그아웃
- 인증 서버에서 토큰 폐기
- 모든 서비스 즉시 무효

### 9.2 JWT 로그아웃
- 쿠키 삭제
- 이미 발급된 토큰은 만료까지 유효

---

## 10. 보안 관점 정리

| 항목 | 이유 |
|---|---|
| HttpOnly | XSS 방지 |
| Secure | 네트워크 탈취 방지 |
| SameSite | CSRF 제어 |
| 토큰 만료 | 피해 최소화 |

---

## 11. 세션 방식과의 차이

| 항목 | 세션 | SSO 쿠키 토큰 |
|---|---|---|
| 인증 범위 | 단일 서비스 | 여러 서비스 |
| 상태 저장 | 서비스 | 인증 서버 |
| SSO | 불가 | 가능 |

---

## 12. 최종 요약

> SSO 쿠키 방식은  
> 쿠키를 쓰지만 세션 방식이 아니다  
> 쿠키는 단순 전달 수단이고  
> 토큰이 인증의 핵심이다  

> Opaque는 중앙 세션형 토큰  
> JWT는 분산 검증형 토큰이다
