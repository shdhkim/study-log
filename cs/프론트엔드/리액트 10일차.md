# 매크로태스크 실행 시점 

React 18 + 브라우저 JavaScript 기준

---

## 1. 핵심 결론

- 자식 컴포넌트가 있어도 규칙은 변하지 않는다.
- 매크로태스크는 부모 + 모든 자식 컴포넌트 렌더링이 전부 끝난 뒤
- DOM 커밋 및 paint 이후, 다음 이벤트 루프 턴에서 실행된다.

---

## 2. 부모·자식 렌더링은 하나의 작업

React 렌더링은 다음을 하나의 덩어리로 처리한다.

```
Parent()
 └─ Child()
    └─ GrandChild()
```

- 자식 렌더는 부모 렌더 도중 동기 호출
- 렌더 중에는 콜스택이 점유됨
- 콜스택이 비지 않으므로
  - 마이크로태스크 실행 불가
  - 매크로태스크 실행 불가

---

## 3. 기준 예제 코드

```jsx
function Child() {
  console.log("Child render");
  return null;
}

function Parent() {
  const [count, setCount] = React.useState(0);

  const onClick = () => {
    setCount(c => c + 1);

    setTimeout(() => {
      console.log("macro");
    }, 0);
  };

  console.log("Parent render");
  return <Child />;
}
```

---

## 4. 이벤트 루프 타임라인 (자식 포함)

### 4.1 클릭 이벤트 (현재 턴)

```
콜스택:
onClick()

React 업데이트 큐:
[ fn(+1) ]
```

---

### 4.2 이벤트 종료 → 렌더링 시작

```
콜스택:
Parent()
 └─ Child()
```

출력:
```
Parent render
Child render
```

---

### 4.3 렌더 종료 → 커밋 & paint

```
콜스택:
(비어 있음)
```

---

### 4.4 다음 이벤트 루프 턴 → 매크로태스크 실행

```
콜스택:
setTimeout 콜백
```

출력:
```
macro
```

---

## 5. 마이크로태스크와의 비교 (자식 포함)

| 구분 | 마이크로태스크 | 매크로태스크 |
|---|---|---|
| 실행 시점 | 콜스택 종료 직후 | 다음 이벤트 루프 |
| 렌더와의 관계 | 렌더 전에 실행 | 렌더 후 실행 |
| 자식 렌더 영향 | 없음 | 없음 |
| 예시 | Promise.then | setTimeout |

---

## 6. 자주 하는 오해 정리

### 오해 1: 자식 렌더가 끝나기 전에 setTimeout이 실행될 수 있다
아님

### 오해 2: setTimeout(0)은 즉시 실행된다
아님

### 오해 3: 자식이 많으면 매크로태스크가 중간에 끼어든다
아님

---

## 7. 한 문장 요약

자식 컴포넌트가 존재하더라도 부모와 자식 렌더링은 하나의 동기 렌더 작업이며,
매크로태스크는 이 렌더링과 DOM 반영이 모두 끝난 뒤
다음 이벤트 루프 턴에서만 실행된다.
