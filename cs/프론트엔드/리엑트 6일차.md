# JavaScript 비동기 & React Batching 정리

---

## 1. 콜백(Callback)이란?

### 정의
콜백 함수란  
**다른 함수에 인자로 전달되어, 나중에 실행되는 함수**다.

```js
function run(cb) {
  cb();
}

run(() => {
  console.log("콜백 실행");
});
```

> 콜백 자체는 동기/비동기를 결정하지 않는다  
> **어디에서 호출/등록되느냐가 실행 방식을 결정한다**

---

## 2. 동기 콜백 vs 비동기 콜백

### 동기 콜백
- 즉시 실행
- 콜스택에서 바로 실행

```js
function run(cb) {
  console.log("1");
  cb();
  console.log("3");
}

run(() => console.log("2"));
```

출력
```
1
2
3
```

---

### 비동기 콜백
- 나중에 실행
- 태스크 큐에 들어갔다가 실행

```js
console.log("1");

setTimeout(() => {
  console.log("2");
}, 0);

console.log("3");
```

출력
```
1
3
2
```

---

## 3. 콜스택(Call Stack)

### 정의
- 현재 실행 중인 함수들이 쌓이는 공간
- LIFO (후입선출)
- JS 엔진은 콜스택에 있는 코드만 실행

```js
function a() {
  b();
}

function b() {
  console.log("b");
}

a();
```

---

## 4. 이벤트 루프(Event Loop)

### 역할
- 콜스택이 비었는지 감시
- 비면 큐에서 작업을 꺼내 콜스택에 올림

### 전체 흐름
```
콜스택 실행
→ 마이크로태스크 전부 실행
→ 렌더링
→ 매크로태스크 1개 실행
→ 반복
```

---

## 5. 마이크로태스크(Microtask)

- Promise.then / catch / finally
- async / await
- queueMicrotask

---

## 6. 매크로태스크(Macrotask)

- setTimeout
- setInterval
- DOM 이벤트

---

## 7. setTimeout(0)이 늦는 이유

- 즉시 실행 ❌
- 매크로태스크 큐 등록
- 마이크로태스크보다 항상 늦음

---

## 8. 이벤트 핸들러(Event Handler)

- 이벤트 발생 시 호출되는 함수
- 매크로태스크로 실행됨

---

## 9. React 이벤트 핸들러

- Synthetic Event 사용
- 이벤트 핸들러 = 하나의 렌더 트랜잭션

---

## 10. React Batching

- 여러 setState → 렌더 1번
- 성능 최적화

```js
setCount(c => c + 1);
setCount(c => c + 1);
```

---

## 11. React 18 자동 Batching

- 이벤트 핸들러
- Promise / async
- setTimeout 내부까지 적용 (같은 이벤트 루프 턴)

---

## 12. batching이 깨지는 경우

- 다음 매크로태스크(setTimeout)

---

## 13. flushSync

### 정의
- batching 강제 종료
- 즉시 렌더링

```js
flushSync(() => {
  setCount(1);
});
```

---

## 14. flushSync 주의사항

- 성능 저하
- DOM 중간 상태 노출
- 정말 필요한 경우만 사용

---

## 15. 전체 요약

```
콜백은 함수다
Promise → 마이크로태스크
setTimeout → 매크로태스크

React는 같은 이벤트 루프 턴이면 batching
flushSync는 batching을 강제로 끊는다
```
