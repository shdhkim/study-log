# React 부모–자식 컴포넌트 렌더링 완전 정리
(콜스택 · 마이크로태스크 · 매크로태스크 · React 업데이트 큐 기준)

이 문서는 **React 18 + 브라우저 JavaScript 기준**으로  
**부모–자식 컴포넌트가 렌더링될 때 실제로 어떤 순서로 실행되는지**를  
정리함


---

## 1. 핵심 결론 먼저

1. 부모와 자식 컴포넌트 렌더링은 **하나의 렌더링 작업**이다.
2. 자식 컴포넌트는 **부모 렌더 도중에 동기적으로 호출**된다.
3. 렌더링 중에는 **마이크로태스크가 절대 실행되지 않는다**.
4. 마이크로태스크는 **부모 + 자식 렌더가 전부 끝난 뒤** 실행된다.
5. 렌더링은 **콜스택과 마이크로태스크 큐가 모두 비었을 때** 시작된다.

---

## 2. 기준 예제 코드

```jsx
function Child({ value }) {
  console.log("Child render", value);

  Promise.resolve().then(() => {
    console.log("Child microtask");
  });

  return <div>Child: {value}</div>;
}

function Parent() {
  const [count, setCount] = React.useState(0);

  console.log("Parent render", count);

  const onClick = () => {
    setCount(c => c + 1);
    console.log("handler end");
  };

  return (
    <>
      <button onClick={onClick}>+</button>
      <Child value={count} />
    </>
  );
}
```

---

## 3. 이벤트 발생 직후 (렌더링 전)

### 3.1 클릭 이벤트 시작

```
콜스택:
  onClick()

마이크로태스크 큐:
  (비어 있음)

매크로태스크 큐:
  (다음 턴 대기)

React 업데이트 큐:
  (비어 있음)
```

---

### 3.2 setState 호출

```js
setCount(c => c + 1);
```

중요한 점:
- setState 호출 자체는 **콜스택에서 동기 실행**
- 상태는 즉시 바뀌지 않음

```
콜스택:
  onClick()

React 업데이트 큐:
  [ fn(c => c + 1) ]

마이크로태스크 큐:
  (비어 있음)
```

---

### 3.3 이벤트 핸들러 종료

```js
console.log("handler end");
```

```
콜스택:
  (비어 있음)

마이크로태스크 큐:
  (비어 있음)

React 업데이트 큐:
  [ fn(c => c + 1) ]
```

이 시점에서:
- 콜스택 비어 있음
- 마이크로태스크도 없음
→ **React 렌더링 가능 상태**

---

## 4. React 렌더링 시작 (부모 → 자식)

### 4.1 Parent 컴포넌트 렌더 진입

```
콜스택:
  Parent()
```

출력:
```
Parent render 1
```

---

### 4.2 Parent 렌더 도중 Child 호출

```jsx
<Child value={count} />
```

이는 내부적으로:

```js
Child({ value: count });
```

콜스택 구조:

```
콜스택:
  Parent()
    └─ Child()
```

출력:
```
Child render 1
```

중요:
- Child는 별도 태스크가 아님
- 그냥 **부모 렌더 중간에 호출되는 함수**

---

## 5. 자식 렌더 중 마이크로태스크 등록

```js
Promise.resolve().then(() => {
  console.log("Child microtask");
});
```

이 순간:

```
콜스택:
  Parent()
    └─ Child()

마이크로태스크 큐:
  [ childThen ]   // 등록만 됨

React 업데이트 큐:
  (처리 중)
```

중요:
- 마이크로태스크는 **등록만**
- 실행은 ❌ (콜스택이 비지 않았기 때문)

---

## 6. 부모 + 자식 렌더 종료

렌더 함수들이 전부 종료되면:

```
콜스택:
  (비어 있음)

마이크로태스크 큐:
  [ childThen ]

React:
  Virtual DOM 계산 완료
```

이제 JS 엔진이 마이크로태스크 실행 가능

---

## 7. 마이크로태스크 실행 시점

```
콜스택:
  childThen()
```

출력:
```
Child microtask
```

중요:
- 마이크로태스크는 **렌더링 이후**
- 렌더 도중에는 절대 실행되지 않음

---

## 8. 전체 타임라인 요약

```
[이벤트 턴]
onClick()
  └─ setState → 업데이트 큐
onClick 종료

[렌더 단계]
Parent()
  └─ Child()

[렌더 종료]
콜스택 비움
→ 마이크로태스크 실행
→ DOM 커밋
→ paint
```

---

## 9. 자주 하는 오해 정리

### 오해 1: 자식 렌더는 마이크로태스크다
아님  
→ **동기 함수 호출**

---

### 오해 2: 부모 렌더가 끝난 뒤 자식이 따로 렌더된다
아님  
→ **부모 렌더 중간에 자식이 실행됨**

---

### 오해 3: 렌더 중 Promise.then이 바로 실행된다
아님  
→ **콜스택이 비어야 실행됨**

---

## 10. 핵심 공식

### 렌더링 시작 조건
```
콜스택 비움
+ 마이크로태스크 큐 비움
```

### 부모–자식 렌더 구조
```
Parent()
 └─ Child()
```

---

## 11. 한 문장 요약

React에서 부모와 자식 컴포넌트는 하나의 렌더링 작업으로 처리되며,  
자식 컴포넌트는 부모 렌더 도중 콜스택 안에서 동기적으로 호출되고,  
렌더링 중 등록된 마이크로태스크는 모든 렌더가 끝난 뒤 실행된다.
