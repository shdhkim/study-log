# Spring Cloud + FastAPI 연동 정리

## 1. 기본 개념

Spring Cloud는 여러 Spring 서비스 간 통신을 관리하는 프레임워크이다.
하지만 FastAPI는 Spring 생태계가 아니므로 **Eureka 서비스로 등록되지
않는다.**

따라서 FastAPI는 Spring Cloud 내부 서비스가 아니라 **내부망에 존재하는
HTTP API 서버**로 취급한다.

즉:

-   Spring ↔ Spring : 서비스 디스커버리(Eureka/Service DNS)
-   Spring ↔ FastAPI : 내부 HTTP API 호출

------------------------------------------------------------------------

## 2. 전체 구조에서 위치

    사용자
      ↓ HTTPS
    CloudFront
      ↓
    Gateway
      ↓
    RECOMMEND-SERVICE (Spring)
      ↓
    FastAPI (AI 분석 서버)
      ↓
    Model / GPU

FastAPI는 MSA의 일부지만 Spring Cloud 관리 대상은 아니다.

------------------------------------------------------------------------

## 3. 연결 방식 (EC2 환경)

같은 VPC 내부라면 Private IP로 호출한다.

예:

    http://10.0.2.22:8000/analyze

조건: 1. 같은 VPC 2. Security Group 허용 3. Private IP 사용

인터넷을 통과하지 않으므로 HTTP 사용 가능하다.

------------------------------------------------------------------------

## 4. Spring에서 호출하는 방법

### 4.1 WebClient 사용

``` java
@Service
public class AiClient {

    private final WebClient webClient =
        WebClient.builder()
            .baseUrl("http://10.0.2.22:8000")
            .build();

    public String analyze(String imageUrl) {
        return webClient.post()
                .uri("/analyze")
                .bodyValue(Map.of("imageUrl", imageUrl))
                .retrieve()
                .bodyToMono(String.class)
                .block();
    }
}
```

가장 일반적인 방식이다.

------------------------------------------------------------------------

### 4.2 OpenFeign 사용 (Spring Cloud 기능 활용)

``` java
@FeignClient(name="ai-server", url="http://10.0.2.22:8000")
public interface AiFeignClient {

    @PostMapping("/analyze")
    String analyze(@RequestBody Map<String, String> body);
}
```

장점: - 재시도 - 타임아웃 - 서킷브레이커 적용 가능

AI 서버 연동 시 실무에서 자주 사용된다.

------------------------------------------------------------------------

## 5. Kubernetes 환경일 때

Kubernetes에서는 IP 대신 Service DNS 사용.

예:

    http://ai-service

Spring 설정:

``` java
@FeignClient(name="ai", url="http://ai-service")
```

Kubernetes DNS가 FastAPI Pod로 연결한다.

역할 분리: - 연결: Kubernetes - 호출 제어: Spring Cloud

------------------------------------------------------------------------

## 6. 왜 Eureka에 등록하지 않는가

Eureka 등록 조건: - Spring Boot 애플리케이션 - Actuator 헬스체크 -
Heartbeat 전송

FastAPI는 해당 기능이 없으므로 등록 불가능.

따라서 고정 주소를 가진 내부 API 서버로 취급한다.

------------------------------------------------------------------------

## 7. 절대 하면 안되는 구조

    React → FastAPI 직접 호출

문제: - Mixed Content 발생 - 인증 쿠키 전달 문제 - 보안 취약점 - 내부망
노출

올바른 구조:

    React → Spring → FastAPI

FastAPI는 내부 서비스여야 한다.

------------------------------------------------------------------------

## 8. 정리

  통신 대상               방식
  ----------------------- -------------------------------------------
  Spring ↔ Spring         서비스 디스커버리(Feign + Eureka/K8s DNS)
  Spring ↔ FastAPI(EC2)   Private IP HTTP
  Spring ↔ FastAPI(K8s)   Service DNS
  브라우저 ↔ FastAPI      금지

------------------------------------------------------------------------

## 최종 결론

FastAPI는 Spring Cloud 서비스로 등록하지 않고, Spring 애플리케이션이
내부망 HTTP API 서버로 호출한다. 필요 시 Feign을 사용하여 재시도,
타임아웃, 서킷브레이커 등 Spring Cloud의 안정성 기능을 그대로 적용할 수
있다.
