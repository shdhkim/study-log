
# Spring Cloud · Eureka · DNS · VPC · Load Balancer 상세 정리 


------------------------------------------------------------

## 1. IP 기반 통신의 근본적인 문제

마이크로서비스 환경에서 서비스 호출은 필연적으로 서버 간 통신을 포함한다.

예시:

ORDER → USER 서비스 호출

초기 방식:

http://10.0.1.23:8080/users/1

이 방식의 문제는 "IP는 서비스 주소가 아니라 서버 좌표"라는 점이다.

서버 IP가 바뀌는 상황:
- EC2 장애 복구
- Auto Scaling
- 배포 교체
- 컨테이너 재생성
- 서버 점검 이동

예시 변화:

어제 USER 서버: 10.0.1.23  
오늘 USER 서버: 10.0.1.57

→ 호출 실패 → 전체 서비스 장애

### 핵심 문제
IP는 변한다.  
서비스는 변하지 않는다.

따라서 시스템에는 다음 개념이 필요하다:

- 서버 주소(Server Address) : 물리적 위치값
- 서비스 주소(Service Address) : 논리적 기능 이름

Spring Cloud는 이 "서비스 주소"를 제공하기 위한 기술이다.

------------------------------------------------------------

## 2. Eureka의 역할 (서비스 디스커버리)

Eureka는 마이크로서비스 환경의 내부 서비스 주소록 서버다.

역할:
- 서비스 인스턴스 등록
- 살아있는 서버 목록 유지
- 위치 조회 제공
- 장애 서버 제거

### 서비스 등록 과정

서비스 기동 시:

USER 서비스 → Eureka 서버

POST /eureka/apps/user-service

등록 정보:
- 서비스 이름
- 사설 IP
- 포트

예:
user-service → 10.0.1.57:8080

Eureka는 메모리에 저장한다.

### Heartbeat (헬스 체크)

서비스는 일정 주기로 다음을 보낸다:

PUT /eureka/apps/user-service/instance-id

이 신호가 끊기면:
Eureka는 해당 인스턴스를 죽은 것으로 판단하고 목록에서 제거한다.

→ 자동 장애 감지

------------------------------------------------------------

## 3. 실제 서비스 호출 흐름

ORDER 서비스 코드:

@FeignClient(name="user-service")

동작 과정:

1) ORDER → Eureka 위치 조회
2) 인스턴스 목록 반환
3) LoadBalancer가 하나 선택
4) 실제 HTTP 호출 수행

Eureka 응답 예:

10.0.1.57:8080  
10.0.1.62:8080  
10.0.1.70:8080

Spring Cloud LoadBalancer:
→ Round Robin 선택

실제 요청:

http://10.0.1.62:8080/users/1

즉 내부적으로는 REST HTTP 호출이며, Spring Cloud는 "대상 서버 선택"을 담당한다.

------------------------------------------------------------

## 4. 장애 상황 처리 (Resilience)

문제 상황:
USER 서비스 응답 지연

발생 현상:
ORDER 대기 → PAY 대기 → 전체 시스템 지연

이를 Cascading Failure라고 한다.

Spring Cloud / Resilience4j 기능:

- Timeout
- Retry
- Circuit Breaker
- Fallback

예:
USER 장애 시 기본 사용자 반환 또는 캐시 반환

효과:
서비스 전체 다운 방지

------------------------------------------------------------

## 5. Eureka 서버 IP 문제

중요한 역설이 발생한다.

서비스 IP는 변하므로 Eureka를 사용한다.
하지만 Eureka도 서버다.

즉:

Eureka IP도 변한다.

잘못된 설정:

defaultZone: http://10.0.0.5:8761/eureka

Eureka 교체 → IP 변경 → 모든 서비스 등록 실패 → 전체 장애

------------------------------------------------------------

## 6. 해결 방법: 내부 DNS

Eureka를 IP가 아니라 이름으로 접근한다.

예:

eureka.internal

Route53 Private Hosted Zone:

eureka.internal → 10.0.0.5

설정 변경:

defaultZone: http://eureka.internal:8761/eureka

### 서버 교체 시

기존:
10.0.0.5

새 서버:
10.0.0.21

DNS 레코드만 변경:
eureka.internal → 10.0.0.21

효과:
- 서비스 재배포 없음
- 코드 수정 없음
- 장애 없음

------------------------------------------------------------

## 7. 내부 로드밸런서 구조

더 안정적인 구조:

eureka.internal → 내부 NLB/ALB → Eureka 서버 여러 대

장점:
- Eureka 서버 장애 대응
- 무중단 운영
- 확장성

구조:

서비스들
   ↓
eureka.internal (DNS)
   ↓
Internal Load Balancer
   ↓
Eureka Cluster

------------------------------------------------------------

## 8. VPC와 통신 방식

### 같은 VPC
- 사설 IP 통신 가능
- HTTP 사용 가능
- 인터넷 경유 없음
- 가장 안전하고 빠름

Spring → http://10.0.2.22:8000

### 다른 VPC
- 사설 IP 사용 불가
- Public 접근 필요
- HTTPS 필요

Spring → https://api.example.com

### VPC Peering
- 서로 다른 VPC를 사설망으로 연결
- 내부 통신 복원

------------------------------------------------------------

## 9. DNS, Spring Cloud, LoadBalancer 역할 구분

DNS 역할:
Eureka 서버 찾기

Spring Cloud 역할:
서비스 인스턴스 찾기

LoadBalancer 역할:
트래픽 분산 및 장애 대응

정리:

DNS → Discovery Server 위치 해결  
Eureka → 서비스 위치 해결  
LoadBalancer → 트래픽 분산

------------------------------------------------------------

## 10. Kubernetes 환경과 비교

Kubernetes가 대체하는 영역:
- 서비스 발견 (CoreDNS)
- 내부 로드밸런싱 (Service)
- 헬스 체크 (Probe)
- Pod 교체

Spring Cloud가 계속 담당:
- Retry
- Timeout
- Circuit Breaker
- Fallback
- 호출 정책

즉:

Kubernetes = 연결과 실행 환경
Spring Cloud = 호출 제어

------------------------------------------------------------

## 11. 전체 아키텍처 흐름

사용자
↓
도메인
↓
CloudFront / ALB
↓
Gateway (선택)
↓
Spring 서비스들
↓
Eureka (내부 DNS 통해 접근)
↓
각 서비스 인스턴스

핵심:
IP는 외부로 노출되지 않으며 내부에서만 사용된다.

------------------------------------------------------------

## 최종 핵심 요약

- 서버 IP는 항상 변한다.
- 서비스는 변하지 않는다.
- Spring Cloud는 서비스 이름으로 서버를 찾게 한다.
- Eureka는 서비스 위치를 관리한다.
- Eureka도 DNS로 접근해야 안정적이다.
- 내부 로드밸런서는 장애 대응과 확장을 담당한다.
- Kubernetes는 실행 플랫폼, Spring Cloud는 호출 제어 계층이다.
