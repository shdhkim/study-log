 CloudFront + Nginx + HTTPS + 혼합 콘텐츠(Mixed Content) 정리 (확장판)

## 1. 전체 구조

### (1) CloudFront + Nginx + 백엔드 구성
```
[브라우저]
   ↓ (HTTPS)
[CloudFront (CDN + HTTPS)]
   ↓ (HTTP or HTTPS)
[Nginx (EC2)]
   ├─ /            → React 정적 파일 (로컬 or S3 프록시)
   ├─ /api/*       → Spring Boot
   └─ /ml/*        → FastAPI
```

### (2) CloudFront 단독 구성 (Nginx 없이)
```
[브라우저]
   ↓ (HTTPS)
[CloudFront]
   ├─ /api/* → EC2(Spring)
   ├─ /ml/*  → EC2(FastAPI)
   └─ /*     → S3 (React build)
```

---

## 2. HTTPS 처리 위치

| 구간 | 프로토콜 | 인증서 필요 | 설명 |
|------|-----------|--------------|------|
| 브라우저 ↔ CloudFront | HTTPS | ACM | 외부 HTTPS 종단 (필수) |
| CloudFront ↔ Nginx | HTTP or HTTPS | 선택 | 내부 구간, 필요 시 certbot 사용 |
| Nginx ↔ Spring/FastAPI | HTTP | 불필요 | 같은 서버/VPC 내부 통신이면 HTTP로 충분 |

### 일반적인 구성
```
브라우저 ⇄ (HTTPS) ⇄ CloudFront ⇄ (HTTP) ⇄ Nginx ⇄ (HTTP) ⇄ 백엔드
```

- CloudFront에서 ACM 인증서로 HTTPS 처리
- 내부 구간은 HTTP 통신이라도 혼합 콘텐츠 발생 없음
- 필요 시 CloudFront→Nginx 구간도 HTTPS로 강화 가능

---

## 3. 정적 파일 처리

### (1) Nginx에서 직접 정적 파일 제공
```
location / {
    root /var/www/frontend;
    index index.html;
    try_files $uri /index.html;
}
```
- React build 파일(`/var/www/frontend`)을 직접 서빙  
- Nginx가 SPA fallback(`/index.html`) 처리  

### (2) Nginx가 S3로 프록시
```
location / {
    proxy_pass https://my-s3-bucket.s3.ap-northeast-2.amazonaws.com;
}
```
- CloudFront가 Nginx로 요청 →  
  Nginx가 내부적으로 S3 정적 파일을 프록시  

### (3) CloudFront에서 정적 파일 캐싱
- CloudFront가 S3를 직접 오리진으로 설정  
- `Path pattern: /*` → S3 (정적 파일 캐싱)  
- `/api/*`, `/ml/*`은 EC2로 분기  

---

## 4. 혼합 콘텐츠(Mixed Content)란?

정의:  
HTTPS 페이지 내에서 브라우저가 직접 HTTP 리소스를 요청할 때 발생하는 오류

### 발생 예시
```js
// 현재 페이지: https://example.com
fetch('http://api.example.com/users');  // 혼합 콘텐츠 발생
```

```
Mixed Content: The page at 'https://example.com' was loaded over HTTPS,
but requested an insecure resource 'http://api.example.com/users'.
```

### 안전한 예시
```js
// 같은 도메인 상대경로 (CloudFront + Nginx 내부 처리)
fetch('/api/users');  // 안전 (브라우저는 HTTPS로 인식)
```

---

## 5. 혼합 콘텐츠 발생 여부 정리

| 통신 구간 | HTTP 사용 가능? | 혼합 콘텐츠 발생? | 이유 |
|------------|------------------|-------------------|------|
| 브라우저 ↔ CloudFront | 불가 (HTTPS 필수) | 발생 | 브라우저 직접 HTTP 요청 시 |
| CloudFront ↔ Nginx | 가능 | 없음 | 서버 간 내부 통신 |
| Nginx ↔ Spring/FastAPI | 가능 | 없음 | 서버 간 내부 통신 |
| React fetch('http://...') | 불가 | 발생 | 브라우저 직접 요청 |

---

## 6. CloudFront 단독 구성 시 차이점

| 항목 | CloudFront 단독 | CloudFront + Nginx |
|------|------------------|--------------------|
| 분기 단위 | Origin (S3, EC2 등) | Path (/api, /ml 등) |
| 세부 라우팅 | 불가능 (Behavior 단위만) | 가능 (Nginx location 사용) |
| 정적 파일 | S3에서 직접 서빙 | Nginx에서 직접 or S3 프록시 |
| SSL 인증서 | CloudFront(ACM)만 필요 | CloudFront(필수) + Nginx(선택) |
| 캐싱 | CloudFront 캐싱 | Nginx 캐시 또는 CloudFront 병행 |
| 관리 복잡도 | 낮음 | 약간 높음 (EC2 필요) |
| 고급 기능 (Rewrite, Header 제어 등) | 불가 | 가능 |

정리하자면:  
- CloudFront 단독: 단순, 저비용, 소규모 서비스에 적합  
- CloudFront + Nginx: 대규모/복합 경로(API, ML, 정적 등)에 적합  

---

## 7. HTTPS 설정 체크리스트

| 항목 | 설명 |
|------|------|
| ACM 인증서 발급 | AWS Certificate Manager에서 `example.com` 발급 |
| CloudFront 연결 | Viewer Protocol Policy: `Redirect HTTP to HTTPS` |
| Route53 연결 | `example.com` → CloudFront 도메인으로 ALIAS 설정 |
| 프론트엔드 API 호출 | 항상 `/api/...` 또는 `https://` 사용 (`http://` 금지) |
| CloudFront→Nginx 구간 암호화 | Nginx certbot 인증서 추가 후 Origin Protocol Policy를 `HTTPS Only`로 설정 |

---

## 8. 요약

| 항목 | 설명 |
|------|------|
| CloudFront | HTTPS, CDN, 큰 단위 분기 (Origin 단위) |
| Nginx | 내부 세부 분기 (Path 단위), 정적 파일 서빙 가능 |
| 혼합 콘텐츠 | 브라우저가 직접 HTTP 요청할 때만 발생 |
| 해결 방법 | 프론트 요청을 HTTPS 또는 상대경로(`/api/...`)로 변경 |
| 인증서 필요 위치 | CloudFront(필수), Nginx(선택) |

---

## 9. 결론

- 브라우저는 항상 HTTPS → CloudFront 로 통신  
- CloudFront ↔ Nginx는 HTTP여도 혼합 콘텐츠 발생하지 않음  
- 혼합 콘텐츠는 오직 프론트 코드에서 직접 HTTP 호출할 때만 발생  
- CloudFront 하나만 HTTPS 설정해도 대부분의 경우 충분  
- 정적 파일은 Nginx 또는 S3에서 서빙 가능  

CloudFront = 전 세계 HTTPS/CDN 관문  
Nginx = 내부 API/정적파일 분배기  
S3 = 정적 자산 저장소  
브라우저가 직접 HTTP를 호출하지 않으면 혼합 콘텐츠는 생기지 않는다.
