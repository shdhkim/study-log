
# JPA N+1 ë¬¸ì œ & ìì‹ ì—”í‹°í‹° ì‚­ì œ ìƒì„¸ ì •ë¦¬ (Full Version)

## 1. N+1 ë¬¸ì œ

### ì¿¼ë¦¬ íë¦„ (ì „í˜•ì ì¸ N+1)

1. ì²« ë²ˆì§¸ ì¿¼ë¦¬ (1ë²ˆ)
```sql
SELECT * FROM member;
```

2. ë©¤ë²„ê°€ 5ëª… ìˆë‹¤ê³  ê°€ì •í•˜ë©´, ê° ë©¤ë²„ì˜ teamì„ Lazy ë¡œë”©í•˜ë©´ì„œ
```sql
SELECT * FROM team WHERE team_id = ?; -- 5ë²ˆ
```

â¡ ì´ **6ë²ˆ ì¿¼ë¦¬ (1 + N)**  
â¡ ë°ì´í„° ìˆ˜ê°€ ë§ì•„ì§ˆìˆ˜ë¡ **ì„±ëŠ¥ì´ í­ë°œì ìœ¼ë¡œ ë‚˜ë¹ ì§„ë‹¤**

---

### 1-2. ì™œ ë°œìƒí•¨? (Lazy/Eager ë‘˜ ë‹¤ ê°€ëŠ¥)

#### (1) Lazy ë¡œë”©ì—ì„œì˜ N+1

- ì—°ê´€ê´€ê³„ì— `fetch = FetchType.LAZY` ì¸ ê²½ìš°
- ì—°ê´€ ê°ì²´ì— **ì‹¤ì œë¡œ ì ‘ê·¼í•˜ëŠ” ìˆœê°„** SELECT ì‹¤í–‰

```java
member.getTeam().getName();
```

â¡ Member ìˆ˜ë§Œí¼ Team ì¿¼ë¦¬ê°€ ì¶”ê°€ ì‹¤í–‰ â†’ **N+1**

---

#### (2) Eager ë¡œë”©ì—ì„œë„ N+1 ê°€ëŠ¥

`fetch = FetchType.EAGER` ì´ë¼ê³  í•´ì„œ í•­ìƒ JOINìœ¼ë¡œ í•œ ë²ˆì— ê°€ì ¸ì˜¤ëŠ” ê²ƒ âŒ

Hibernate ì „ëµì— ë”°ë¼:

1) Memberë§Œ ë¨¼ì € ì¡°íšŒ  
2) ê° Memberë‹¹ Teamì„ ê°œë³„ ì¿¼ë¦¬ë¡œ ì¡°íšŒ â†’ **ë™ì¼í•œ N+1 ë°œìƒ**

---

**ê²°ë¡ **

> Lazyë“  Eagerë“  ì„¤ê³„ ì•ˆ í•˜ë©´ ë‘˜ ë‹¤ N+1 ë‚œë‹¤

âœ” ì‹¤ë¬´ì—ì„œëŠ” **ê¸°ë³¸ì„ ëª¨ë‘ LAZY**ë¡œ ë‘ê³   
âœ” í•„ìš”í•œ ì¡°íšŒë§ˆë‹¤ **ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì„¤ê³„**í•˜ëŠ” íŒ¨í„´ì´ ì •ì„

---

### 1-3. JPAì—ì„œ ì¿¼ë¦¬ê°€ ì–¸ì œ ë‚˜ê°€ë‚˜? (ê°œë… íë¦„)

1ï¸âƒ£ `em.createQuery("select m from Member m")` â†’ Member ëª©ë¡ì„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë¡œë”©  
2ï¸âƒ£ ì—°ê´€ê´€ê³„ í•„ë“œ(`m.team`)ëŠ”  
- LAZY â†’ í”„ë¡ì‹œ ê°ì²´  
- EAGER â†’ ì¦‰ì‹œ ë¡œë”©í•˜ì§€ë§Œ ì¶”ê°€ ì¿¼ë¦¬ ë°œìƒ ê°€ëŠ¥  
3ï¸âƒ£ `member.getTeam().getName()` ì ‘ê·¼ ì‹œ SELECT ì‹¤í–‰

â¡ ì´ íŒ¨í„´ì´ ë°˜ë³µ â†’ **N+1**

---

### 1-4. N+1 ë¬¸ì œ í•´ê²° ë°©ë²•

#### 1) Fetch Join (ê°€ì¥ ëŒ€í‘œì ì¸ í•´ê²°ì±…)

```java
select m from Member m join fetch m.team
```

#### ì‹¤í–‰ SQL

```sql
SELECT m.*, t.*
FROM member m
JOIN team t ON m.team_id = t.id;
```

â¡ ë£¨í”„ì—ì„œ Team ì ‘ê·¼í•´ë„ ì¶”ê°€ ì¿¼ë¦¬ ì—†ìŒ

---

#### 2) @EntityGraph ì‚¬ìš©

```java
@EntityGraph(attributePaths = {"team"})
@Query("select m from Member m")
List<Member> findAllWithTeam();
```

- ë‚´ë¶€ì ìœ¼ë¡œ fetch join ë¹„ìŠ·í•œ ìµœì í™”

---

#### 3) Batch Size (ë°°ì¹˜ ë¡œë”©)

Lazy ìœ ì§€í•˜ë©´ì„œ **ë¬¶ì–´ì„œ IN ì¡°íšŒ**

```yaml
spring.jpa.properties.hibernate.default_batch_fetch_size: 100
```

SQL ì˜ˆì‹œ:

```sql
SELECT * FROM team WHERE id IN (?, ?, ?, ...);
```

---

### í•´ê²° ì •ë¦¬

| ë°©ë²• | íŠ¹ì§• |
|------|------|
| Fetch Join | íŠ¹ì • ì¡°íšŒì—ì„œ ê°€ì¥ ê°•ë ¥ |
| EntityGraph | ë©”ì†Œë“œ ë‹¨ìœ„ ë¡œë”© ì „ëµ |
| Batch Size | Lazy ìœ ì§€í•˜ë©´ì„œ ìµœì í™” |

---

### 1-5. ì‹¤ë¬´ ê¸°ë³¸ ì „ëµ

âœ” ëª¨ë“  ì—°ê´€ê´€ê³„ ê¸°ë³¸ LAZY  
âœ” ì¡°íšŒ ì„±ê²©ì— ë”°ë¼ Fetch Join / DTO ì¡°íšŒ  
âœ” í•­ìƒ ë¡œê·¸ë¡œ ì„±ëŠ¥ í™•ì¸ â†’ N+1 ë°œìƒ ì‹œ ì¦‰ì‹œ ìˆ˜ì •

---

## 2. ìì‹ í…Œì´ë¸”(ìì‹ ì—”í‹°í‹°) ì‚­ì œ

### 2-1. ìˆœìˆ˜ DBì—ì„œì˜ ìì‹ ì‚­ì œ

```sql
CREATE TABLE parent (
    id BIGINT PRIMARY KEY
);

CREATE TABLE child (
    id BIGINT PRIMARY KEY,
    parent_id BIGINT,
    CONSTRAINT fk_child_parent
        FOREIGN KEY (parent_id)
        REFERENCES parent(id)
        ON DELETE NO ACTION -- ì˜ˆì‹œ
);
```

#### ì‚­ì œ ì‹œë‚˜ë¦¬ì˜¤

| ìƒí™© | DB ë™ì‘ |
|------|---------|
| ìì‹ë§Œ ì‚­ì œ | ë¬¸ì œ ì—†ìŒ |
| ë¶€ëª¨ ì‚­ì œ | ì‚­ì œ ë¶ˆê°€ â†’ ìì‹ ìˆ˜ì • í•„ìš” |

ì˜µì…˜ì— ë”°ë¼ ë™ì‘ ë³€ê²½ ê°€ëŠ¥:
- ON DELETE CASCADE  
- ON DELETE SET NULL  
- NO ACTION (ê¸°ë³¸)

---

### 2-2. JPA ë¶€ëª¨â€“ìì‹ ë§¤í•‘ êµ¬ì¡°

```java
@Entity
public class Parent {
    @Id @GeneratedValue
    private Long id;

    @OneToMany(mappedBy = "parent")
    private List<Child> children = new ArrayList<>();
}
```

```java
@Entity
public class Child {
    @Id @GeneratedValue
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "parent_id")
    private Parent parent;
}
```

ğŸ“Œ FK ë³´ìœ  = ì—°ê´€ê´€ê³„ ì£¼ì¸(Child)

---

### 2-3. ì‚­ì œ ì‹œë‚˜ë¦¬ì˜¤ë³„ ì •ë¦¬

#### A. ìì‹ ì—”í‹°í‹° ì§ì ‘ ì‚­ì œ

```java
em.remove(child);
```

DB ì…ì¥: ë¬¸ì œ ì—†ìŒ  
í•˜ì§€ë§Œ Parentì˜ childrenì— childê°€ **ë‚¨ì•„ìˆì„ ê°€ëŠ¥ì„±** â‡’ ë¶ˆì¼ì¹˜ ë¬¸ì œ

---

#### B. orphanRemoval ì‚¬ìš©

```java
@OneToMany(mappedBy = "parent", cascade = CascadeType.ALL, orphanRemoval = true)
```

```java
parent.removeChild(child);
```

â¡ ê´€ê³„ ëŠê¸´ ìì‹ = ê³ ì•„ ì—”í‹°í‹° â†’ ìë™ DELETE

---

#### C. ë¶€ëª¨ ì‚­ì œ(cascade)

```java
em.remove(parent);
```

â¡ ë¶€ëª¨ + ìì‹ ëª¨ë‘ ì‚­ì œ

---

### 2-4. ì™œ child.setParent(null)ì´ í•„ìš”í•œê°€?

| ì´ìœ  |
|------|
| ì–‘ë°©í–¥ ê·¸ë˜í”„ ì¼ê´€ì„± ìœ ì§€ |
| orphanRemoval ì¸ì‹ ì¡°ê±´ |
| DB/ë©”ëª¨ë¦¬ ë°ì´í„° ë™ê¸°í™” |

```java
children.remove(child);
child.setParent(null);
```

---

### 2-5. ì‚­ì œ ë°˜ì˜ ì‹œì  (íŠ¸ëœì­ì…˜)

| ì‹œì  | ë™ì‘ |
|------|------|
| remove() í˜¸ì¶œ | ì‚­ì œ ìƒíƒœ í‘œì‹œ |
| flush / commit | ì‹¤ì œ DELETE ì‹¤í–‰ |

â†’ ê°™ì€ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œëŠ” ì‚­ì œëœ ê²ƒì²˜ëŸ¼ ë™ì‘ ğŸ¤œğŸ¤›

---

### 2-6. ìì‹ ì‚­ì œ ì •ë¦¬ í‘œ

| ìƒí™© | ì½”ë“œ | SQL |
|------|------|-----|
| ìì‹ë§Œ ì‚­ì œ | remove(child) | DELETE |
| orphanRemoval | removeChild | ìë™ DELETE |
| ë¶€ëª¨ ì‚­ì œ | remove(parent) | ë¶€ëª¨+ìì‹ DELETE |
| ê´€ê³„ë§Œ ë‹¨ì ˆ | setParent(null) | UPDATE FK NULL |

---

## 3. í•œ ë²ˆì— ìš”ì•½

| í•­ëª© | í•µì‹¬ ë‚´ìš© |
|------|-----------|
| N+1 | ì—°ê´€ ì—”í‹°í‹° ì ‘ê·¼ ì‹œ ì¶”ê°€ ì¿¼ë¦¬ ë°œìƒ |
| Lazy/Eager | ë‘˜ ë‹¤ N+1 ë¬¸ì œ ê°€ëŠ¥ |
| í•´ê²° | Fetch Join / EntityGraph / Batch Size |
| ìì‹ ì‚­ì œ | orphanRemoval + cascade í™œìš© |
| ì–‘ë°©í–¥ ê´€ê³„ | í•­ìƒ ì–‘ìª½ ëª¨ë‘ ì—°ê´€ ì •ë¦¬ í•„ìˆ˜ |

---