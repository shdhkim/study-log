# Oracle SQL – GROUP BY + 윈도우 함수 완전 정리

본 문서는 Oracle 기준으로 **GROUP BY와 윈도우 함수(OVER, PARTITION BY)**의 관계를
실무 관점에서 단계적으로 정리한 문서이다.

---

## 예제 테이블

```sql
SALES
---------------------------
REGION   PRODUCT   AMOUNT
---------------------------
SEOUL    A         100
SEOUL    A         200
SEOUL    B         300
BUSAN    A         150
BUSAN    B         50
BUSAN    B         100
```

---

## 1. GROUP BY만 사용한 기본 집계

```sql
SELECT
  REGION,
  PRODUCT,
  SUM(AMOUNT) AS TOTAL_AMT
FROM SALES
GROUP BY REGION, PRODUCT;
```

### 결과

```text
REGION  PRODUCT  TOTAL_AMT
SEOUL   A        300
SEOUL   B        300
BUSAN   A        150
BUSAN   B        150
```

### 특징

* GROUP BY는 행 수를 줄인다
* 순수 요약 단계

---

## 2. GROUP BY + 윈도우 함수 (핵심 패턴)

### 지역별 상품 매출 + 지역 총합

```sql
SELECT
  REGION,
  PRODUCT,
  SUM(AMOUNT) AS PRODUCT_SUM,
  SUM(SUM(AMOUNT)) OVER (PARTITION BY REGION) AS REGION_TOTAL
FROM SALES
GROUP BY REGION, PRODUCT;
```

### 실행 순서

1. GROUP BY REGION, PRODUCT
2. 그 결과에 대해 OVER(PARTITION BY REGION) 실행

### 결과

```text
REGION  PRODUCT  PRODUCT_SUM  REGION_TOTAL
SEOUL   A        300          600
SEOUL   B        300          600
BUSAN   A        150          300
BUSAN   B        150          300
```

### 핵심 포인트

* 이중 SUM 구조 필수
* 안쪽 SUM은 집계
* 바깥 SUM OVER는 분석

---

## 3. GROUP BY 결과에 비율 계산

```sql
SELECT
  REGION,
  PRODUCT,
  SUM(AMOUNT) AS PRODUCT_SUM,
  ROUND(
    SUM(AMOUNT)
    / SUM(SUM(AMOUNT)) OVER (PARTITION BY REGION)
  , 2) AS REGION_RATIO
FROM SALES
GROUP BY REGION, PRODUCT;
```

### 의미

* 각 상품이 해당 REGION에서 차지하는 비율
* GROUP BY 단독으로는 불가능

---

## 4. GROUP BY + 순위 매기기

```sql
SELECT
  REGION,
  PRODUCT,
  SUM(AMOUNT) AS PRODUCT_SUM,
  RANK() OVER (
    PARTITION BY REGION
    ORDER BY SUM(AMOUNT) DESC
  ) AS REGION_RANK
FROM SALES
GROUP BY REGION, PRODUCT;
```

### 특징

* 집계 후 순위 계산
* ORDER BY에 집계 결과 사용 가능

---

## 5. GROUP BY 결과에 전체 합계 추가

```sql
SELECT
  REGION,
  PRODUCT,
  SUM(AMOUNT) AS PRODUCT_SUM,
  SUM(SUM(AMOUNT)) OVER () AS TOTAL_SUM
FROM SALES
GROUP BY REGION, PRODUCT;
```

### 의미

* OVER()는 전체 결과 집합 기준

---

## 6. GROUP BY vs 윈도우 함수 차이

| 구분    | GROUP BY | 윈도우 함수       |
| ----- | -------- | ------------ |
| 행 수   | 줄어듦      | 유지           |
| 목적    | 요약       | 비교 / 비율 / 순위 |
| 단독 사용 | 가능       | 불가           |
| 같이 사용 | 가능       | 가능           |

---

## 7. PARTITION BY 없이 윈도우 함수 사용

```sql
SUM(SUM(AMOUNT)) OVER ()
```

* 전체 기준
* PARTITION BY 전체와 동일한 의미

```sql
SUM(SUM(AMOUNT)) OVER (ORDER BY REGION)
```

* 전체 기준 누적 합계

---

## 8. SUM(AMOUNT) OVER ()의 의미

```sql
SELECT
  REGION,
  PRODUCT,
  AMOUNT,
  SUM(AMOUNT) OVER () AS TOTAL_SUM
FROM SALES;
```

### 특징

* GROUP BY 아님
* 행 수 유지
* 전체 합계를 모든 행에 복사

---

## 9. SUM(AMOUNT) OVER () + GROUP BY가 불가능한 이유

```sql
SELECT
  REGION,
  SUM(AMOUNT) OVER ()
FROM SALES
GROUP BY REGION;
```

* ORA-00979 발생
* 윈도우 함수는 GROUP BY 대상이 아님
* GROUP BY 이후 단계에서 실행됨

---

## 10. 올바른 조합 패턴 (서브쿼리)

```sql
SELECT
  REGION,
  REGION_SUM,
  SUM(REGION_SUM) OVER () AS TOTAL_SUM
FROM (
  SELECT
    REGION,
    SUM(AMOUNT) AS REGION_SUM
  FROM SALES
  GROUP BY REGION
);
```

---

## 11. GROUP BY + PARTITION BY 개념 정리

* GROUP BY: 데이터를 만든다
* PARTITION BY: 만들어진 데이터를 분석한다

---

## 12. PARTITION BY REGION, PRODUCT의 의미

```sql
SELECT
  REGION,
  PRODUCT,
  SUM(AMOUNT) AS PRODUCT_SUM,
  SUM(SUM(AMOUNT)) OVER (PARTITION BY REGION, PRODUCT) AS PART_SUM
FROM SALES
GROUP BY REGION, PRODUCT;
```

### 결과

```text
PRODUCT_SUM = PART_SUM
```

### 이유

* GROUP BY 이후 (REGION, PRODUCT)는 이미 1행
* 같은 기준으로 PARTITION하면 의미 없음

---

## 13. PARTITION BY (REGION, PRODUCT)가 의미 있는 경우

```sql
SELECT
  REGION,
  PRODUCT,
  AMOUNT,
  SUM(AMOUNT) OVER (PARTITION BY REGION, PRODUCT) AS PRODUCT_SUM
FROM SALES;
```

* 원본 행 유지
* 그룹 합계 분석에 적합

---

## 14. 실무 판단 기준

"이 PARTITION 기준에서 행이 여러 개 남아 있는가"

* YES: 의미 있음
* NO: 자기 자신 복사

---

## 최종 요약

* GROUP BY는 행을 줄이는 요약 단계
* 윈도우 함수는 줄어든 결과를 비교하는 분석 단계
* 동일 컬럼으로 GROUP BY와 PARTITION BY를 함께 쓰는 경우는 대부분 불필요
* 이중 SUM 구조는 GROUP BY + 윈도우 함수의 핵심 패턴
